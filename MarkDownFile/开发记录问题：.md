## 微信小程序中的问题：



    可以内置手机号验证码

    1.问题：session_key失效
        通过前台传入的iv,code,encryptedData，nick后台通过接受这些参数
        code: "033gH7422h46pV0nDA222hCa422gH74d"
        encryptedData: "WzOuQVxdCRM6VzQ8Oxdtp5e+x1D7yo4e8TwAxFkA4wDSrK89SY0+fugD8QF3I3Q7Fw61moaqCO6h1hvQofs/+5f+mZcojg7TcTni7au4M8dCWDAEgg/Xk6jHejs2Pu4CGC3dct/lxXN8FqDC04zE4AXBNImw6q9RTsH7p5H4+JJn3nVZBTm+jrgcb4ZNQ6EtzUS/c3Bqp97lerGxp0CbW8m40TZu18BIBnKn77GCNo8WsL8fgFmxUmUVDxWbW7wRXCLDkjOmaGrYcExnZSmVAmh5rpl3S84L9IcxJyaBl/SYadqa+ttSXMWaWtmSGLl1JUrh4qn9uU4fb4s6OBMuZLN/M7x+7u2i6l5GHaOF+jvCYbduibtjbhop4OOk+mlTEy2XgMuVdJVorTK5fcDvkyA9wJqWQTWL3Xm3uvgK1JwDkjGT/SIOydwjWwKmRQgrduxQ/bruzVhDNaunSdsZv2HYd4OIc0wZUxTXzPuUQLrHdegMPCP5Dsm4wR5DH1bixEgkcBgBV21PGVD/n5VWBA=="
        iv: "MIU0nuFdCk/dqeTjQrQUbQ=="
        nick: "Kay三石"
        拼接出xcxLoginUrl = "https://api.weixin.qq.com/sns/jscode2session?appid=%s&secret=%s&js_code=%s&grant_type=authorization_code";
        通过微信返回的json数据置换出session_key，
        通过session_key和iv,code,encryptedData,通过加密/解密算法解密出
        unionid，和openid,通过唯一的unionId获取到userid的用户信息
        总的来说，就是不能点击按钮后，才调用wx.login，必须先wx.login后，才能点击按钮，这时候的session_key才是正确的
        使用的时候，确保微信小程序在同一个开发者账号平台下，不然获取不到unionid,unionID是微微信唯一的身份标识
        WeChatSecret weChatSecret = weChatConfig.getSecrets().get(client.toUpperCase());
            String loginUrl = String.format(xcxLoginUrl, weChatSecret.getAppId(), weChatSecret.getAppSecret(), request.getCode());
            String result = restTemplate.getForObject(loginUrl, String.class);
            WeXCXLoginCheckResponse checkResponse = new WeXCXLoginCheckResponse();
            String encryptedData = request.getEncryptData();
            JSONObject jsonSessionKey = new JSONObject(result);
            String iv = request.getIv();
            String sessionKey = jsonSessionKey.getString("session_key");
            checkResponse.setSession_key(sessionKey);
            String decryptData = null;
            try {
            	//解密出unionID和OpenId
                decryptData = AESUtil.decrypt(encryptedData, sessionKey, iv, "UTF-8");
            } catch (Exception e) {
                e.printStackTrace();
            }
            if (StringUtil.isEmptyOrBlank(decryptData))
                throw new BusinessException(ErrorCode.AUTHORIZE_FAILED);
            JSONObject jsonData = new JSONObject(decryptData);
            String unionId = jsonData.getString("unionId");
            String openId = jsonData.getString("openId");
            String userId = this.findUserIdByTypeAndSocialId(unionId, SocialLoginType.WE_CHAT.toString().toUpperCase());
    2.辨别不同的小程序的使用：
        通过header进行辨别是否是同一个小程序
    3.app分享这个小程序连接到微信
    	1.必须把这个app和小程序绑定到一个开放平台账号下才可以进行使用
    	

## 短信邀请：

只需要手机号码就可以：

```java
// 查询该班级已绑定未激活的手机号
        List<InvitationModel> childInvitationModel = invitationDao.getInvitationPhoneNumbersByGroupId(groupId);
        List<String> keys = new ArrayList<>();
        childInvitationModel.forEach(ci -> {
            String childId = ci.getChildId();
            String phoneNumber = ci.getUserEmail();
            keys.add(childId + phoneNumber + groupId);
        });
        // 校验发送次数，如果超出则提示
        if (shieldProvider.isOperationExcessive(ip, ShieldLimitType.PLG_INVITE_PARENT_SMS, 500)) {
            throw new BusinessException(ErrorCode.IP_SEND_SMS_EXCESSIVE, MSG.t("IP_SEND_SMS_EXCESSIVE"));
        }
        List<String> newKeys = new ArrayList<>();
        for (int i = 0; i < keys.size(); i++) {
            if (!shieldProvider.isOperationExcessive(keys.get(i), ShieldLimitType.PLG_INVITE_PARENT_SMS, 1)) {
                newKeys.add(keys.get(i));
            }
        }
        if (newKeys.isEmpty()) {
            throw new BusinessException(ErrorCode.INVITE_PARENT_SMS_EXCESSIVE, MSG.t("INVITE_PARENT_SMS_EXCESSIVE"));
        }
        // 发送短信
        AgencyEntity agency = agencyDao.getByGroupId(groupId);
        String agencyName = "";
        String defaultAgencyId = "";
        if (agency != null) {
            agencyName = agency.getName();
            defaultAgencyId = agency.getId();
        }
        for (InvitationModel invitationModel : childInvitationModel) {
            String childId = invitationModel.getChildId();
            String phoneNumber = invitationModel.getUserEmail();
            String childName = invitationModel.getChildName();
            String contact = childId + phoneNumber + groupId;
            if (!newKeys.contains(contact)) continue;
            // 手机号发送验证码次数+1(用于限制手机号单日最大发送短信数量)
            shieldProvider.userOperationINCR(contact, ShieldLimitType.PLG_INVITE_PARENT_SMS);
            // IP发送验证码次数+1(用于限制IP单日最大发送短信数量)
            shieldProvider.userOperationINCR(ip, ShieldLimitType.PLG_INVITE_PARENT_SMS);
            ShortMessage message = new ShortMessage();
            message.setContent();
            message.setReceiver(phoneNumber);
            AgencyMetaDataEntity agencytype = agencyDao.getMeta(defaultAgencyId, AgencyMetaKey.WXMP_USERNAME.toString());
            // 短信类型:sendMsg方法会根据短信类型选择 不同的短信模板
            if (agencytype != null && !StringUtil.isEmptyOrBlank(agencytype.getMetaValue())) {
                message.setSignName(SmsUtil.findSingNameBySmsType(ShortMessageType.PLG_INVITE_PARENT_HCY));
                message.setType(ShortMessageType.PLG_INVITE_PARENT_HCY);
            } else {
                message.setSignName(SmsUtil.findSingNameBySmsType(ShortMessageType.PLG_INVITE_PARENT));
                message.setType(ShortMessageType.PLG_INVITE_PARENT);
            }

            try {
                shortMessageProvider.sendMsg(message);
            } catch (Exception e) {
                e.printStackTrace();
                throw new BusinessException(ErrorCode.SMS_SEND_FAILURE, MSG.t("SMS_SEND_FAILURE"));
            }
        }
```

sendMsg方法：

```Java
@Override
    public Boolean sendMsg(ShortMessage message) throws ClientException {
        SendSmsRequest request = new SendSmsRequest();
        request.setPhoneNumbers(message.getReceiver());
        // SignName在阿里云短信管理页面可查
        request.setSignName(message.getSignName());
        request.setTemplateCode(SmsUtil.findTemplateCodeBySmsType(message.getType()));
        request.setTemplateParam(message.getContent().replaceAll("Mr.", ""));
        // 选填-上行短信扩展码(无特殊需求用户请忽略此字段)
        // request.setSmsUpExtendCode("90997");
        // 可选:outId为提供给业务方扩展字段,最终在短信回执消息中将此值带回给调用者
        // request.setOutId("yourOutId");
        // hint 此处可能会抛出异常，注意catch
        SendSmsResponse sendSmsResponse = null;
      	//阿里云提供的接口
        sendSmsResponse = acsClient.getAcsResponse(request);
        // 非法手机号
        if (Objects.equals("isv.MOBILE_NUMBER_ILLEGAL", sendSmsResponse.getCode())) {
            throw new BusinessException(ErrorCode.PHONE_NUMBER_ILLEGAL, MSG.t("PHONE_NUMBER_ILLEGAL"));
        }
        return Objects.equals("OK", sendSmsResponse.getCode());
    }
```

## wkhtml转pdf



```
public void dashboardPdf(final String userId, final ExportDashboardPdfRequest request) {
        String frameworkId = request.getFrameworkId();
        UserEntity user = userProvider.checkUser(userId);
        DashboardDataRequest dataRequest = this.processPdfData(request, user);
        String htmlPath = ResourceUtil.createHtmlFile(dataRequest, "dashboard/observation_and_rating+measures.html");
        File htmlFile = new File(htmlPath);
        String key = "html/" + UUID.randomUUID() + ".html";
        fileSystem.upload(pdfBucket, key, htmlFile);
        String htmlUrl = fileSystem.getPublicUrl(pdfBucket, key);
        htmlUrl = htmlUrl.replace(s3Root, pdfEndpoint);
        List<String> htmlUrls = new ArrayList<>();
        htmlUrls.add(htmlUrl);
        //处理文件名字
        String fileName = "Dashboard";
        if (domainNames.get(frameworkId) == null) {
            DomainEntity domain = domainDao.getDomain(frameworkId);
            domainNames.put(frameworkId, domain.getName());
        }
        String domainName = domainNames.get(frameworkId);
        fileName = fileName + "_" + domainName + ".pdf";

        //保存上传的htmlUrl
        PdfConvertJobEntity pdfConvertJobEntity = new PdfConvertJobEntity();
        pdfConvertJobEntity.setUrl(org.apache.commons.lang3.StringUtils.join(htmlUrls, ","));
        pdfConvertJobEntity.setStatus(PdfConvertStatus.CREATED.toString());
        pdfConvertJobEntity.setCreatedBy(userId);
        pdfConvertJobEntity.setCreatedAtUtc(TimeUtil.getUtcNow());
        pdfConvertJobEntity.setType(PdfType.DASHBOARD_FRAMEWORK_PDF.toString());
        pdfConvertJobEntity.setPdfName(fileName);
        pdfConvertJobEntity.setData(domainName);
        reportDao.createPdfConvertJob(pdfConvertJobEntity);
    }
```

```
public static String createHtmlFile(Object data, String templateName) {
        String jsonData = JsonUtil.toJson(data);
        String template = ResourceUtil.getResourceAsString(templateName);
        String htmlStr = template.replace("@{data}", jsonData);

        String htmlFilePath = FileUtil.randomTempFilePath(".html");
        FileUtil.createStringFile(htmlFilePath, htmlStr);
        return htmlFilePath;
    }
```

使用：

```
<script type="text/javascript">
    var data = @{data};
    通过这个data进行获取数据
```